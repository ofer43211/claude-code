name: Tests

on:
  push:
    branches: [ main, "claude/**" ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Job 1: Lint bash scripts
  shellcheck:
    name: ShellCheck (Bash Linting)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.devcontainer'
          severity: warning
          format: gcc

  # Job 2: Lint GitHub Actions workflows
  actionlint:
    name: ActionLint (Workflow Linting)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download actionlint
        run: |
          bash <(curl https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
          echo "${PWD}" >> $GITHUB_PATH

      - name: Run actionlint
        run: actionlint -color

  # Job 3: Run bash script tests with bats
  bats-tests:
    name: Bats Tests (Bash Scripts)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install bats
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: Run firewall script tests
        run: bats tests/scripts/firewall.bats

      - name: Run workflow validation tests
        run: bats tests/workflows/workflow-validation.bats

  # Job 4: Test composite actions - claude-code-action
  test-claude-code-action:
    name: Test Claude Code Action
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run claude-code-action tests
        run: |
          # Test 1: Missing both prompt and prompt_file should fail
          echo "Test 1: Verifying missing prompt detection..."
          PROMPT=""
          PROMPT_FILE=""
          if [ -z "$PROMPT" ] && [ -z "$PROMPT_FILE" ]; then
            echo "✓ Correctly detected missing inputs"
          else
            echo "ERROR: Should detect missing inputs"
            exit 1
          fi

          # Test 2: Empty prompt should fail
          echo "Test 2: Verifying empty prompt detection..."
          mkdir -p /tmp/test-prompts
          touch /tmp/test-prompts/empty.txt
          if [ ! -s "/tmp/test-prompts/empty.txt" ]; then
            echo "✓ Correctly detected empty prompt file"
          else
            echo "ERROR: Should detect empty file"
            exit 1
          fi

          # Test 3: Valid prompt string should create temp file
          echo "Test 3: Testing prompt file creation..."
          PROMPT="Test prompt content"
          mkdir -p /tmp/claude-action
          PROMPT_PATH="/tmp/claude-action/prompt.txt"
          echo "$PROMPT" > "$PROMPT_PATH"
          if [ -s "$PROMPT_PATH" ]; then
            echo "✓ Prompt file created successfully"
          else
            echo "ERROR: Prompt file creation failed"
            exit 1
          fi

          # Test 4: Timeout conversion
          echo "Test 4: Testing timeout conversion..."
          TIMEOUT_MINUTES=10
          timeout_seconds=$((TIMEOUT_MINUTES * 60))
          if [ "$timeout_seconds" -eq 600 ]; then
            echo "✓ Timeout converted correctly"
          else
            echo "ERROR: Timeout conversion failed"
            exit 1
          fi

          echo "All claude-code-action tests passed!"

  # Job 5: Test composite actions - claude-issue-triage-action
  test-claude-issue-triage-action:
    name: Test Claude Issue Triage Action
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify action configuration
        run: |
          ACTION_FILE=".github/actions/claude-issue-triage-action/action.yml"

          # Test 1: Verify required inputs
          echo "Test 1: Checking required inputs..."
          if grep -A2 "anthropic_api_key:" "$ACTION_FILE" | grep -q "required: true"; then
            echo "✓ anthropic_api_key is required"
          else
            echo "ERROR: anthropic_api_key should be required"
            exit 1
          fi

          # Test 2: Verify timeout default
          echo "Test 2: Checking timeout default..."
          if grep -A2 "timeout_minutes:" "$ACTION_FILE" | grep -q 'default: "5"'; then
            echo "✓ Default timeout is 5 minutes"
          else
            echo "ERROR: Default timeout should be 5"
            exit 1
          fi

          # Test 3: Verify allowed tools
          echo "Test 3: Checking allowed tools list..."
          if grep -q "mcp__github__get_issue" "$ACTION_FILE"; then
            echo "✓ get_issue tool is allowed"
          else
            echo "ERROR: get_issue should be allowed"
            exit 1
          fi

          # Test 4: Verify no-comment instructions
          echo "Test 4: Checking no-comment instructions..."
          count=$(grep -c "DO NOT post any comments" "$ACTION_FILE" || true)
          if [ "$count" -ge 2 ]; then
            echo "✓ No-comment instruction is emphasized ($count times)"
          else
            echo "ERROR: Should emphasize no-comment instruction"
            exit 1
          fi

          # Test 5: Verify GitHub MCP installation
          echo "Test 5: Checking GitHub MCP installation..."
          if grep -q 'install_github_mcp: "true"' "$ACTION_FILE"; then
            echo "✓ GitHub MCP installation is enabled"
          else
            echo "ERROR: GitHub MCP should be enabled"
            exit 1
          fi

          echo "All claude-issue-triage-action tests passed!"

  # Job 6: Security checks
  security-checks:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for potential hardcoded secrets..."

          # Check for common secret patterns (allow test placeholders)
          if grep -r -i "AKIA[0-9A-Z]\{16\}" --exclude-dir=.git --exclude-dir=tests .; then
            echo "ERROR: Found potential AWS access key"
            exit 1
          fi

          # Check for private key patterns
          if grep -r "BEGIN.*PRIVATE KEY" --exclude-dir=.git --exclude-dir=tests .; then
            echo "ERROR: Found potential private key"
            exit 1
          fi

          echo "✓ No hardcoded secrets found"

      - name: Verify firewall script security
        run: |
          echo "Checking firewall script security..."
          SCRIPT=".devcontainer/init-firewall.sh"

          # Verify it has set -euo pipefail
          if grep -q "set -euo pipefail" "$SCRIPT"; then
            echo "✓ Script uses safe bash settings"
          else
            echo "ERROR: Script should use 'set -euo pipefail'"
            exit 1
          fi

          # Verify it validates CIDR ranges
          if grep -q "Invalid CIDR range" "$SCRIPT"; then
            echo "✓ Script validates CIDR ranges"
          else
            echo "ERROR: Script should validate CIDR ranges"
            exit 1
          fi

          # Verify it validates IP addresses
          if grep -q "Invalid IP from DNS" "$SCRIPT"; then
            echo "✓ Script validates IP addresses"
          else
            echo "ERROR: Script should validate IP addresses"
            exit 1
          fi

          echo "✓ Firewall script security checks passed"

  # Job 7: Documentation checks
  documentation:
    name: Documentation Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check README exists and is not empty
        run: |
          if [ ! -s "README.md" ]; then
            echo "ERROR: README.md is missing or empty"
            exit 1
          fi
          echo "✓ README.md exists and has content"

      - name: Check test coverage analysis exists
        run: |
          if [ ! -s "TEST_COVERAGE_ANALYSIS.md" ]; then
            echo "ERROR: TEST_COVERAGE_ANALYSIS.md is missing or empty"
            exit 1
          fi
          echo "✓ TEST_COVERAGE_ANALYSIS.md exists"

      - name: Check for broken links in markdown files
        run: |
          # Simple check for common broken link patterns
          for file in *.md; do
            if [ -f "$file" ]; then
              # Check for broken relative links
              if grep -o '\[.*\](\.\/.*\)' "$file" | while read -r link; do
                path=$(echo "$link" | sed 's/.*](\(.*\))/\1/')
                if [ ! -e "$path" ]; then
                  echo "ERROR: Broken link in $file: $link"
                  exit 1
                fi
              done; then
                echo "✓ No broken links in $file"
              fi
            fi
          done

  # Job 8: Test coverage summary
  test-summary:
    name: Test Coverage Summary
    runs-on: ubuntu-latest
    needs: [shellcheck, actionlint, bats-tests, test-claude-code-action, test-claude-issue-triage-action, security-checks]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ShellCheck | ${{ needs.shellcheck.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ActionLint | ${{ needs.actionlint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bats Tests | ${{ needs.bats-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Claude Code Action Tests | ${{ needs.test-claude-code-action.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Claude Issue Triage Tests | ${{ needs.test-claude-issue-triage-action.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Checks | ${{ needs.security-checks.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any tests failed
        if: |
          needs.shellcheck.result == 'failure' ||
          needs.actionlint.result == 'failure' ||
          needs.bats-tests.result == 'failure' ||
          needs.test-claude-code-action.result == 'failure' ||
          needs.test-claude-issue-triage-action.result == 'failure' ||
          needs.security-checks.result == 'failure'
        run: exit 1
